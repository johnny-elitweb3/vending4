<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIFI Vending Machine Widget</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.5.2/web3.min.js"></script>
    <style>
        :root {
            --primary: #e84142;
            --secondary: #ff6b6b;
            --background: #f8f9fa;
            --text: #2d3436;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        body {
            margin: 0;
            padding: 10px;
            height: 100vh;
            overflow-y: auto;
            background: var(--background);
            color: var(--text);
        }
        .widget-container {
            max-width: 100%;
            margin: 0 auto;
        }
        .container {
            height: 100vh;
            overflow: auto;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.connect-wallet {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: 0.3s;
}
.connect-wallet:hover {
    background: var(--secondary);
}
.vending-machine {
    background: white;
    margin: 20px auto;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}
.vending-machine-header {
    text-align: center;
    margin-bottom: 20px;
}
.token-grid {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px; /* Add space between products */
}
.token-item {
    flex: 1;
    max-width: 300px;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
}
.token-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.token-item .token-icon {
    width: 50px;
    height: 50px;
    margin: 0 auto 10px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}
.token-price {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--primary);
    margin: 10px 0;
}
.buy-button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: 0.3s;
    font-weight: bold;
    width: 100%;
    margin-top: 10px;
}
.buy-button:hover {
    background: var(--secondary);
    transform: translateY(-2px);
}
.token-balance {
    display: flex;
    justify-content: space-around;
    background: #e9ecef;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
}
.token-balance #tokenBalance {
    display: flex;
    gap: 20px;
}
.token-balance #tokenBalance div {
    padding: 8px 15px;
    background: white;
    border-radius: 5px;
    margin: 0 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.main-content {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-top: 20px;
}
.news-feed {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.post-form {
    margin-bottom: 20px;
}
.post-type {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.post-content {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    min-height: 100px;
}
.post-button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}
.messages {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.message-list {
    margin-bottom: 20px;
}
.message {
    padding: 10px;
    border-bottom: 1px solid #ddd;
}
.message-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
}
.wallet-status {
    color: var(--primary);
    font-weight: bold;
}
.cost-info {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    font-size: 0.9em;
    color: #666;
}
.token-item .buy-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.error-message {
    color: var(--primary);
    padding: 10px;
    margin: 10px 0;
    background: #ffe6e6;
    border-radius: 5px;
    display: none;
}
/* Add this CSS for the modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}
.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 10px;
    position: relative;
}
.modal-header {
    margin-bottom: 20px;
}
.modal-header h2 {
    margin: 0;
    color: var(--primary);
}
.modal-body {
    margin-bottom: 20px;
}
.modal-body input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.modal-footer {
    text-align: right;
}
.close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.close:hover {
    color: var(--primary);
}
</style>
</head>
<body>
    <div class="container">
        <div class="vending-machine">
            <div class="vending-machine-header">
                <h2>Welcome</h2>
                <p>Purchase tokens to interact with the social platform</p>
            </div>

            <nav>
                <h1>CIFI Vending Machine</h1>
                <div>
                    <span class="wallet-status" id="walletStatus">Not Connected</span>
                    <button class="connect-wallet" id="connectWallet">Connect Wallet</button>
                </div>
            </nav>          
            
            <div class="token-balance">
                Your Balance: <div id="tokenBalance">
                    <div>0 wCIFI</div>
                    <div>0 wREFI</div>
                </div>
            </div>

            <div class="token-grid">
                <div class="token-item">
                    <div class="token-icon">wCIFI</div>
                    <h3>wCIFI Token</h3>
                    <p id="availableSupply0">0 wCIFI Available</p>
                    <p class="token-price" id="tokenPrice0">0 wREFI per token</p>
                    <button class="buy-button" onclick="purchaseTokens(0)">Buy wCIFI</button>
                </div>
                
                <div class="token-item">
                    <div class="token-icon">wREFI</div>
                    <h3>wREFI Token</h3>
                    <p id="availableSupply1">0 wREFI Available</p>
                    <p class="token-price" id="tokenPrice1">0 wCIFI per token</p>
                    <button class="buy-button" onclick="purchaseTokens(1)">Buy wREFI</button>
                </div>

                <div class="token-item">
                    <div class="token-icon">wREFI</div>
                    <h3>wREFI Premium Token</h3>
                    <p id="availableSupply2">0 wREFI Available</p>
                    <p class="token-price" id="tokenPrice2">5 wCIFI per token</p>
                    <button class="buy-button" onclick="purchaseTokens(2)">Buy Premium wREFI</button>
                </div>
            </div>
        </div>

        <div id="purchaseModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="modal-header">
                    <h2 id="modalProductName">Purchase Tokens</h2>
                </div>
                <div class="modal-body">
                    <p id="modalProductId">Product ID: 0</p>
                    <input type="number" id="purchaseAmount" placeholder="Enter amount of tokens to purchase">
                    <p id="totalCost"></p>
                </div>
                <div class="modal-footer">
                    <button class="buy-button" onclick="confirmPurchase()">Confirm Purchase</button>
                </div>
            </div>
        </div>

        <iframe 
            src="https://your-domain.com/vending-machine.html" 
            style="width: 100%; height: 800px; border: none; overflow: hidden;"
            id="vendingMachineFrame"
            allow="web3.js; ethereum"
        ></iframe>

        <script>
        window.addEventListener('message', function(event) {
            // Validate origin for security
            const allowedOrigins = ['https://your-domain.com']; // Update with actual allowed domains
            if (!allowedOrigins.includes(event.origin)) {
                return;
            }

            switch(event.data.type) {
                case 'connect':
                    connectWallet();
                    break;
                case 'purchase':
                    purchaseTokens(event.data.productId);
                    break;
                case 'getBalance':
                    loadBalances().then(balances => {
                        window.parent.postMessage({
                            type: 'balances',
                            data: balances
                        }, event.origin);
                    });
                    break;
            }
        });

        const VENDING_MACHINE_ADDRESS = '0x4dC2eaFAa2Be851f308E6b3017d7754Ecb8c57B0'; // Need the actual vending machine contract address
        const VENDING_MACHINE_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "SafeERC20FailedOperation",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "productToken",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "paymentToken",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    }
                ],
                "name": "ProductAdded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "buyer",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "paymentAmount",
                        "type": "uint256"
                    }
                ],
                "name": "ProductPurchased",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    }
                ],
                "name": "ProductStatusChanged",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "newPrice",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "newSupply",
                        "type": "uint256"
                    }
                ],
                "name": "ProductUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "TokensWithdrawn",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "address",
                        "name": "productToken",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "paymentToken",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "initialSupply",
                        "type": "uint256"
                    }
                ],
                "name": "addProduct",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    }
                ],
                "name": "getProduct",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "string",
                                "name": "name",
                                "type": "string"
                            },
                            {
                                "internalType": "address",
                                "name": "productToken",
                                "type": "address"
                            },
                            {
                                "internalType": "address",
                                "name": "paymentToken",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "price",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "availableSupply",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bool",
                                "name": "isActive",
                                "type": "bool"
                            }
                        ],
                        "internalType": "struct TokenVendingMachine.Product",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "productCount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "products",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "address",
                        "name": "productToken",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "paymentToken",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "availableSupply",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "purchaseProduct",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    }
                ],
                "name": "setProductStatus",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "productId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "newPrice",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "additionalSupply",
                        "type": "uint256"
                    }
                ],
                "name": "updateProduct",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdrawTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        const TOKEN_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "allowance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "success",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "decimals",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "transfer",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "success",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "success",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
        const WREFI_ADDRESS = '0x57f086481F362E1E6051544861A4b1724C9fB99F';
        const WCIFI_ADDRESS = '0x74b910fcf01C7153b80E3940042BB48518f37257';

        let web3;
        let userAccount;
        let vendingMachineContract;
        let wREFIContract;
        let wCIFIContract;

        let purchaseModal = document.getElementById('purchaseModal');
        let closeBtn = document.getElementsByClassName('close')[0];
        let currentPrice = 0;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Request account access in iframe context
                    await window.ethereum.request({ 
                        method: 'eth_requestAccounts',
                        params: [{ eth_accounts: {} }]
                    });
                    
                    web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    userAccount = accounts[0];

                    // Notify parent window of connection
                    window.parent.postMessage({
                        type: 'walletConnected',
                        account: userAccount
                    }, '*');

                    // Initialize contracts and load data
                    initializeContracts();
                    await loadBalances();
                    await loadProductDetails();

                } catch (error) {
                    console.error('Wallet connection error:', error);
                    window.parent.postMessage({
                        type: 'error',
                        message: error.message
                    }, '*');
                }
            } else {
                window.parent.postMessage({
                    type: 'error',
                    message: 'MetaMask not installed'
                }, '*');
            }
        }

        function initializeContracts() {
            vendingMachineContract = new web3.eth.Contract(VENDING_MACHINE_ABI, VENDING_MACHINE_ADDRESS);
            wREFIContract = new web3.eth.Contract(TOKEN_ABI, WREFI_ADDRESS);
            wCIFIContract = new web3.eth.Contract(TOKEN_ABI, WCIFI_ADDRESS);
        }

        // Add new function to load balances
        async function loadBalances() {
            try {
                const wREFIBalance = await wREFIContract.methods.balanceOf(userAccount).call();
                const wCIFIBalance = await wCIFIContract.methods.balanceOf(userAccount).call();
                
                document.getElementById('tokenBalance').innerHTML = `
                    <div>${web3.utils.fromWei(wCIFIBalance, 'ether')} wCIFI</div>
                    <div>${web3.utils.fromWei(wREFIBalance, 'ether')} wREFI</div>
                `;
            } catch (error) {
                console.error('Error loading balances:', error);
            }
        }

        async function loadProductDetails() {
            try {
                // Load Product 0 (wCIFI)
                const product0 = await vendingMachineContract.methods.getProduct(0).call();
                document.getElementById('availableSupply0').textContent = 
                    web3.utils.fromWei(product0.availableSupply, 'ether') + ' wCIFI Available';
                document.getElementById('tokenPrice0').textContent = 
                    web3.utils.fromWei(product0.price, 'ether') + ' wREFI per token';

                // Load Product 1 (wREFI)
                const product1 = await vendingMachineContract.methods.getProduct(1).call();
                document.getElementById('availableSupply1').textContent = 
                    web3.utils.fromWei(product1.availableSupply, 'ether') + ' wREFI Available';
                document.getElementById('tokenPrice1').textContent = 
                    web3.utils.fromWei(product1.price, 'ether') + ' wCIFI per token';

                // Load Product 2 (Premium wREFI)
                const product2 = await vendingMachineContract.methods.getProduct(2).call();
                document.getElementById('availableSupply2').textContent = 
                    web3.utils.fromWei(product2.availableSupply, 'ether') + ' wREFI Available';
                document.getElementById('tokenPrice2').textContent = 
                    web3.utils.fromWei(product2.price, 'ether') + ' wCIFI per token';
            } catch (error) {
                console.error('Error loading product details:', error);
            }
        }

        // Add real-time calculation for purchase amount
        function updatePurchaseModal(productId) {
            const purchaseAmount = document.getElementById('purchaseAmount');
            const totalCostElement = document.getElementById('totalCost');
            
            // Add input event listener for real-time updates
            purchaseAmount.addEventListener('input', function() {
                const amount = this.value;
                if (amount && !isNaN(amount) && amount > 0) {
                    let total;
                    let paymentToken;
                    
                    switch(productId) {
                        case 0:
                            total = amount * currentPrice;
                            paymentToken = 'wREFI';
                            break;
                        case 1:
                            total = amount * currentPrice;
                            paymentToken = 'wCIFI';
                            break;
                        case 2:
                            total = amount * 5; // Fixed price of 5 wCIFI per wREFI
                            paymentToken = 'wCIFI';
                            break;
                    }
                    
                    totalCostElement.textContent = `Total cost: ${total} ${paymentToken}`;
                } else {
                    totalCostElement.textContent = 'Enter amount to see total cost';
                }
            });
        }

        // Update the purchaseTokens function to include the real-time calculator
        async function purchaseTokens(productId) {
            try {
                if (!userAccount) {
                    alert('Please connect your wallet first!');
                    return;
                }
                
                if (!vendingMachineContract) {
                    alert('Vending machine contract not initialized. Please connect wallet first.');
                    return;
                }
                
                // Show the modal
                const purchaseModal = document.getElementById('purchaseModal');
                purchaseModal.style.display = "block";
                
                // Get current price and update modal content
                const product = await vendingMachineContract.methods.getProduct(productId).call();
                currentPrice = web3.utils.fromWei(product.price, 'ether');
                
                // Update modal displays with product specific information
                document.getElementById('modalProductId').textContent = `Product ID: ${productId}`;
                
                let productName;
                switch(productId) {
                    case 0:
                        productName = 'wCIFI';
                        break;
                    case 1:
                        productName = 'wREFI';
                        break;
                    case 2:
                        productName = 'Premium wREFI';
                        break;
                }
                
                document.getElementById('modalProductName').textContent = `Purchase ${productName} Tokens`;
                document.getElementById('totalCost').textContent = 'Enter amount to see total cost';
                document.getElementById('purchaseAmount').value = '';
                
                // Store the current product ID for use in confirmation
                purchaseModal.dataset.productId = productId;
                
                // Initialize real-time calculator
                updatePurchaseModal(productId);
            } catch (error) {
                console.error('Error in purchaseTokens:', error);
                alert('An error occurred while initializing the purchase. Please try again.');
            }
        }

        async function confirmPurchase() {
            try {
                const amount = document.getElementById('purchaseAmount').value;
                const productId = parseInt(purchaseModal.dataset.productId);
                
                // Validate input
                if (!amount || isNaN(amount) || amount <= 0) {
                    throw new Error('Invalid amount');
                }

                const amountInWei = web3.utils.toWei(amount.toString(), 'ether');
                const product = await vendingMachineContract.methods.getProduct(productId).call();
                const paymentAmount = web3.utils.toBN(amountInWei).mul(web3.utils.toBN(product.price))
                    .div(web3.utils.toBN(web3.utils.toWei('1', 'ether')));

                // Handle approvals
                if (productId === 0) {
                    await wREFIContract.methods.approve(VENDING_MACHINE_ADDRESS, paymentAmount)
                        .send({ from: userAccount });
                } else {
                    await wCIFIContract.methods.approve(VENDING_MACHINE_ADDRESS, paymentAmount)
                        .send({ from: userAccount });
                }

                // Execute purchase
                await vendingMachineContract.methods.purchaseProduct(productId, amountInWei)
                    .send({ from: userAccount });

                // Notify parent window
                window.parent.postMessage({
                    type: 'purchaseComplete',
                    productId: productId,
                    amount: amount
                }, '*');

                // Update UI
                purchaseModal.style.display = "none";
                await loadBalances();
                await loadProductDetails();

            } catch (error) {
                console.error('Purchase error:', error);
                window.parent.postMessage({
                    type: 'error',
                    message: error.message
                }, '*');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            
            // Setup modal close handlers
            const purchaseModal = document.getElementById('purchaseModal');
            const closeBtn = document.querySelector('.close');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    purchaseModal.style.display = "none";
                });
            }
            
            window.addEventListener('click', function(event) {
                if (event.target === purchaseModal) {
                    purchaseModal.style.display = "none";
                }
            });
        });
        </script>
    </div>
</body>
</html>
